library(magrittr)
library(ggplot2)


startPop <- c(1682944, 1688838, 1697534, 1704924, 1714042, 1727733, 1743113, 1761683, 1779152, 1793333, 1804833, 1814318, 1823634, 1829725, 1840498, 1851621, 1862137, 1870737, 1879567, 1888062, 1896270, 1904201, 1911895, 1919333, 1926474, 1933291, 1939724, 1945744, 1951336, 1956584, 1961529, 1966161, 1970528, 1974669, 1978638, 1982468, 1986158, 1989771, 1993299, 1996756, 2000129, 2003397, 2006533, 2009533, 2012335, 2014919, 2017256, 2019307, 2021059, 2022475, 2023590, 2024389, 2024885, 2025094, 2025021, 2024718, 2024209, 2023508, 2022662, 2021712, 2020711, 2019679, 2018658, 2017684, 2016766, 2015943, 2015215, 2014594, 2014111, 2013764, 2013553, 2013453, 2013447, 2013524, 2013690, 2013890, 2014131, 2014384, 2014633, 2014863, 2015089, 2015284, 2015475, 2015632, 2015765, 2015887, 2015998, 2016118, 2016252, 2016397, 2016556, 2016744, 2016975, 2017234, 2017535, 2017864, 2018244, 2018656, 2019082, 2019521, 2019991, 2020461, 2020933, 2021418, 2021894, 2022346, 2022780, 2023190, 2023585, 2023971, 2024345, 2024721, 2025096, 2025470, 2025854, 2026241)

endPop <- c(1688838, 1697534, 1704924, 1714042, 1727733, 1743113, 1761683, 1779152, 1793333, 1804833, 1814318, 1823634, 1829725, 1840498, 1851621, 1862137, 1870737, 1879567, 1888062, 1896270, 1904201, 1911895, 1919333, 1926474, 1933291, 1939724, 1945744, 1951336, 1956584, 1961529, 1966161, 1970528, 1974669, 1978638, 1982468, 1986158, 1989771, 1993299, 1996756, 2000129, 2003397, 2006533, 2009533, 2012335, 2014919, 2017256, 2019307, 2021059, 2022475, 2023590, 2024389, 2024885, 2025094, 2025021, 2024718, 2024209, 2023508, 2022662, 2021712, 2020711, 2019679, 2018658, 2017684, 2016766, 2015943, 2015215, 2014594, 2014111, 2013764, 2013553, 2013453, 2013447, 2013524, 2013690, 2013890, 2014131, 2014384, 2014633, 2014863, 2015089, 2015284, 2015475, 2015632, 2015765, 2015887, 2015998, 2016118, 2016252, 2016397, 2016556, 2016744, 2016975, 2017234, 2017535, 2017864, 2018244, 2018656, 2019082, 2019521, 2019991, 2020461, 2020933, 2021418, 2021894, 2022346, 2022780, 2023190, 2023585, 2023971, 2024345, 2024721, 2025096, 2025470, 2025854, 2026241, 2026660)

naturalChange <- data.frame(
  births = c(21565, 21460, 21433, 22049, 22549, 22714, 23850, 25227, 25276, 24981, 25424, 25324, 24527, 24185, 24187, 24379, 23528, 23736, 23502, 23243, 23035, 22907, 22781, 22650, 22509, 22373, 22246, 22138, 22052, 21989, 21950, 21938, 21945, 21997, 22086, 22204, 22348, 22505, 22657, 22799, 22917, 23001, 23051, 23069, 23047, 22997, 22911, 22807, 22687, 22553, 22411, 22276, 22146, 22019, 21905, 21800, 21711, 21636, 21574, 21530, 21498, 21479, 21479, 21489, 21511, 21540, 21583, 21627, 21677, 21727, 21774, 21813, 21845, 21865, 21874, 21869, 21849, 21818, 21772, 21720, 21656, 21587, 21512, 21435, 21359, 21284, 21220, 21158, 21102, 21053, 21013, 20984, 20965, 20952, 20945, 20953, 20954, 20967, 20980, 20995, 21011, 21027, 21039, 21047, 21048, 21049, 21040, 21025, 21003, 20983, 20951, 20911, 20875, 20830, 20787, 20741),
  deaths = c(14421, 14432, 14648, 14736, 14390, 14211, 14555, 14462, 14566, 14006, 14184, 14235, 14968, 14337, 15403, 15341, 15401, 15412, 15536, 15660, 15794, 15931, 16087, 16252, 16420, 16624, 16823, 17044, 17259, 17494, 17746, 17989, 18242, 18494, 18755, 19008, 19266, 19520, 19762, 20010, 20253, 20487, 20710, 20933, 21157, 21369, 21580, 21779, 21984, 22172, 22359, 22527, 22682, 22818, 22929, 23030, 23106, 23156, 23183, 23187, 23168, 23135, 23092, 23024, 22954, 22883, 22808, 22734, 22661, 22593, 22545, 22488, 22452, 22410, 22385, 22358, 22332, 22300, 22282, 22243, 22209, 22155, 22109, 22059, 21993, 21918, 21848, 21773, 21691, 21613, 21544, 21471, 21413, 21361, 21308, 21281, 21253, 21254, 21246, 21249, 21265, 21283, 21298, 21328, 21354, 21375, 21384, 21397, 21391, 21388, 21356, 21326, 21290, 21239, 21181, 21113),
  net = c(7144, 7028, 6785, 7313, 8159, 8503, 9295, 10765, 10710, 10975, 11240, 11089, 9559, 9848, 8784, 9038, 8127, 8324, 7966, 7583, 7241, 6976, 6694, 6398, 6089, 5749, 5423, 5094, 4793, 4495, 4204, 3949, 3703, 3503, 3331, 3196, 3082, 2985, 2895, 2789, 2664, 2514, 2341, 2136, 1890, 1628, 1331, 1028, 703, 381, 52, -251, -536, -799, -1024, -1230, -1395, -1520, -1609, -1657, -1670, -1656, -1613, -1535, -1443, -1343, -1225, -1107, -984, -866, -771, -675, -607, -545, -511, -489, -483, -482, -510, -523, -553, -568, -597, -624, -634, -634, -628, -615, -589, -560, -531, -487, -448, -409, -363, -328, -299, -287, -266, -254, -254, -256, -259, -281, -306, -326, -344, -372, -388, -405, -405, -415, -415, -409, -394, -372),
  stringsAsFactors = FALSE)

ukMigration <- data.frame(
  inflow = c(11645, 12510, 11107, 12245, 13298, 12380, 12932, 12141, 10857, 10667, 10323, 10333, 10364, 11081, 10473, 10806, 10467, 10455, 10434, 10421, 10388, 10325, 10291, 10248, 10209, 10189, 10183, 10190, 10204, 10232, 10281, 10312, 10335, 10344, 10362, 10357, 10346, 10341, 10335, 10320, 10310, 10293, 10296, 10269, 10256, 10243, 10212, 10190, 10149, 10131, 10100, 10073, 10047, 10017, 9996, 9980, 9957, 9942, 9925, 9929, 9923, 9915, 9930, 9915, 9919, 9921, 9911, 9921, 9917, 9919, 9921, 9909, 9890, 9888, 9867, 9856, 9840, 9813, 9800, 9781, 9762, 9746, 9723, 9709, 9692, 9668, 9661, 9650, 9640, 9628, 9626, 9626, 9621, 9610, 9601, 9609, 9612, 9610, 9596, 9599, 9591, 9586, 9585, 9582, 9567, 9552, 9537, 9530, 9520, 9509, 9495, 9484, 9470, 9461, 9441, 9429),
  outflow = c(11669, 11589, 11005, 11858, 11291, 11510, 11142, 10707, 10198, 11279, 11121, 12090, 11815, 11747, 11236, 10806, 11493, 11456, 11410, 11301, 11187, 11110, 11045, 11003, 10979, 11003, 11084, 11190, 11247, 11280, 11351, 11392, 11395, 11376, 11361, 11361, 11313, 11296, 11271, 11234, 11204, 11169, 11135, 11101, 11060, 11032, 10990, 10964, 10934, 10895, 10851, 10824, 10800, 10789, 10773, 10757, 10761, 10766, 10764, 10771, 10783, 10778, 10789, 10796, 10797, 10804, 10805, 10795, 10778, 10762, 10748, 10738, 10704, 10675, 10654, 10624, 10602, 10580, 10558, 10530, 10512, 10485, 10467, 10450, 10434, 10421, 10411, 10399, 10404, 10407, 10405, 10406, 10412, 10398, 10407, 10399, 10399, 10395, 10389, 10373, 10365, 10356, 10339, 10323, 10307, 10290, 10281, 10261, 10244, 10228, 10212, 10192, 10179, 10166, 10158, 10136),
  net = c(-24, 921, 102, 387, 2007, 870, 1790, 1434, 659, -612, -798, -1757, -1451, -666, -763, 0, -1026, -1001, -976, -880, -799, -785, -754, -755, -770, -814, -901, -1000, -1043, -1048, -1070, -1080, -1060, -1032, -999, -1004, -967, -955, -936, -914, -894, -876, -839, -832, -804, -789, -778, -774, -785, -764, -751, -751, -753, -772, -777, -777, -804, -824, -839, -842, -860, -863, -859, -881, -878, -883, -894, -874, -861, -843, -827, -829, -814, -787, -787, -768, -762, -767, -758, -749, -750, -739, -744, -741, -742, -753, -750, -749, -764, -779, -779, -780, -791, -788, -806, -790, -787, -785, -793, -774, -774, -770, -754, -741, -740, -738, -744, -731, -724, -719, -717, -708, -709, -705, -717, -707),
  stringsAsFactors = FALSE)

rowMigration <- data.frame(
  inflow = c(6524, 6488, 6810, 8174, 12544, 15803, 19773, 18261, 14404, 13877, 13401, 12922, 12736, 13300, 13093, 12998, 12501, 12001, 11507, 11507, 10999, 10506, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001, 10001),
  outflow = c(7609, 6393, 6683, 6996, 8861, 8797, 10633, 11981, 11406, 12115, 14097, 12480, 13623, 11063, 10298, 11540, 11002, 10494, 10002, 10002, 9510, 9003, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503, 8503),
  net = c(-1085, 95, 127, 1178, 3683, 7006, 9140, 6280, 2998, 1762, -696, 442, -887, 2237, 2795, 1458, 1499, 1507, 1505, 1505, 1489, 1503, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498, 1498),
  stringsAsFactors = FALSE)

totalMigration <- data.frame(
  inflow = rowMigration$inflow + ukMigration$inflow,
  outflow = rowMigration$outflow + ukMigration$outflow,
  net = (rowMigration$inflow + ukMigration$inflow) - (rowMigration$outflow + ukMigration$outflow)
)

NIPopulationData <- data.frame(
  year = c(2001:2116),
  startPop = startPop,
  naturalChange = naturalChange,
  ukMigration = ukMigration,
  rowMigration = rowMigration,
  totalMigration = totalMigration,
  endPop = endPop,
  stringsAsFactors = FALSE)

NIPopulationJSON <- NIPopulationData %>%
  jsonlite::toJSON(auto_unbox = TRUE, pretty = TRUE)

ggplot(NIPopulationData, aes(year)) +
  geom_line(aes(y = naturalChange.net/1000, colour = "Natural change")) +
  geom_line(aes(y = totalMigration.net/1000, colour = "Net migration")) +
  ggtitle("Natural change and net migration") +
  xlab("Year") +
  ylab("Persons (1,000s)")


# Population projection
# Natural change, net international migration, net UK migration

cutoff <- data.frame(
  x = c(-Inf, Inf), 
  y = 0, 
  cutoff = factor(0))

ggplot(NIPopulationData, aes(year)) +
  geom_line(aes(y = naturalChange.net/1000, colour = "Natural change")) +
  geom_line(aes(y = rowMigration.net/1000, colour = "Net UK migration")) +
  geom_line(aes(y = ukMigration.net/1000, colour = "Net International migration")) +
  geom_vline(aes(xintercept=as.numeric(year[15])),
             linetype=3, colour="black") + 
  geom_hline(yintercept = 0) +
  ggtitle("Natural change and net migration") +
  xlab("Year") +
  ylab("Persons (1,000s)")


# Population projection
### Historical and end population

historicalEndPopulation <- c(1237000, 1238000, 1239000, 1241000, 1242000, 1243000, 1244000, 1245000, 1247000, 1248000, 1251000, 1250000, 1248000, 1249000, 1217000, 1212000, 1215000, 1221000, 1259000, 1269000, 1272000, 1284000, 1278000, 1258000, 1257000, 1254000, 1251000, 1250000, 1246000, 1244000, 1243000, 1251000, 1258000, 1265000, 1271000, 1276000, 1281000, 1286000, 1295000, 1296000, 1288000, 1296000, 1302000, 1316000, 1317000, 1333000, 1339000, 1351000, 1360000, 1369000, 1373000, 1375000, 1384100, 1387300, 1394000, 1397000, 1399000, 1402300, 1407700, 1419800, 1427400, 1435400, 1446000, 1458000, 1469000, 1478000, 1491000, 1502000, 1512500, 1524000, 1540400, 1539000, 1530000, 1526900, 1523500, 1523500, 1523300, 1523200, 1528300, 1532800, 1543000, 1544500, 1550600, 1557300, 1565400, 1573500, 1582000, 1585400, 1590400, 1595600, 1607300, 1623300, 1635600, 1643700, 1649100, 1661800, 1671300, 1677800, 1679000)
historicalYears <- c(1901:1999)

allEndPopulationData <- data.frame(
  endPop = c(historicalEndPopulation, NIPopulationData$endPop),
  year = c(historicalYears, NIPopulationData$year),
  stringsAsFactors = FALSE
)

ggplot(allEndPopulationData, aes(year)) +
  geom_line(aes(y = endPop/1000, colour = "Population")) +
  geom_vline(aes(xintercept=as.numeric(year[114])),
             linetype=3, colour="black") + 
  ggtitle("Historical and projected population") +
  xlab("Year") +
  ylab("Persons (1,000s)")


# Estimated and projected age structure of the NI population
### Mid-2016, mid-2041 and mid-2116

ages <- c(paste0(seq(0, 95, 5)), "100+")
persons2016 <- c(125, 128, 113, 118, 119, 124, 124, 120, 120, 131, 131, 116, 97, 89, 77, 55, 40, 24, 10, 2, 0)
persons2041 <- c(115, 113, 115, 118, 115, 121, 122, 107, 111, 118, 122, 121, 115, 112, 115, 104, 78, 48, 25, 8, 1)
males2016 <- c(64, 65, 58, 61, 61, 62, 61, 58, 59, 64, 64, 57, 48, 43, 36, 25, 16, 9, 3, 1, 0)
females2016 <- c(61, 62, 55, 57, 58, 62, 63, 62, 61, 67, 66, 59, 49, 46, 40, 30, 23, 15, 7, 2, 0)
males2041 <- c(59, 58, 59, 60, 59, 62, 62, 55, 57, 60, 61, 59, 55, 54, 54, 49, 36, 22, 10, 3, 0)
females2041 <- c(56, 55, 56, 57, 56, 59, 60, 52, 54, 58, 62, 62, 60, 58, 60, 55, 42, 27, 15, 5, 1)

df <- data.frame(
  age = ages,
  male = males2016,
  female = females2016,
  stringsAsFactors = FALSE)

names(df) <- c("Age", "Male", "Female")
cols <- 2:3
df[,cols] <- apply(df[,cols], 2, function(x) as.numeric(as.character(gsub(",", "", x))))
df <- df[df$Age != 'Total', ]  
df$Male <- -1 * df$Male
df$Age <- factor(df$Age, levels = df$Age, labels = df$Age)

ageStructure <- melt(df, 
                value.name='Population', 
                variable.name = 'Gender', 
                id.vars='Age' )

ggplot(ageStructure, aes(x = Age, y = Population, fill = Gender)) + 
  geom_bar(subset = .(Gender == "Female"), stat = "identity") + 
  geom_bar(subset = .(Gender == "Male"), stat = "identity") + 
  scale_y_continuous(breaks = seq(-4000000, 4000000, 1000000), 
                     labels = paste0(as.character(c(4:0, 1:4)), "m")) + 
  coord_flip() + 
  scale_fill_brewer(palette = "Set1") + 
  theme_bw()



# Projected population by age group 
### Principal projection

totalPopulationChange <- ((sum(persons2041) / sum(persons2016)) - 1) * 100
childrenPopulationChange <- ((sum(persons2041[1:4]) / sum(persons2016[1:4])) - 1) * 100
workingAgePopulationChange <- ((sum(persons2041[5:13]) / sum(persons2016[5:13])) - 1) * 100
pensionableAgeChange <- ((sum(persons2041[14:21]) / sum(persons2016[14:21])) - 1) * 100

### 50% less future EU migration variant

persons2016.variant <- c(125, 128, 113, 118, 119, 124, 124, 120, 120, 131, 131, 116, 97, 89, 77, 55, 40, 24, 10, 2, 0)
persons2041.variant <- c(110, 108, 110, 114, 111, 116, 117, 102, 106, 113, 120, 119, 113, 110, 114, 104, 78, 48, 25, 8, 1)

totalPopulationChange.variant <- ((sum(persons2041.variant) / sum(persons2016.variant)) - 1) * 100
childrenPopulationChange.variant <- ((sum(persons2041.variant[1:4]) / sum(persons2016.variant[1:4])) - 1) * 100
workingAgePopulationChange.variant <- ((sum(persons2041.variant[5:13]) / sum(persons2016.variant[5:13])) - 1) * 100
pensionableAgeChange.variant <- ((sum(persons2041.variant[14:21]) / sum(persons2016.variant[14:21])) - 1) * 100

### Low migration (Northern Ireland)

persons2016.lowMigration <- c(125, 128, 113, 118, 119, 124, 124, 120, 120, 131, 131, 116, 97, 89, 77, 55, 40, 24, 10, 2, 0)
persons2041.lowMigration <- c(107, 105, 107, 112, 110, 114, 113, 98, 101, 109, 117, 117, 112, 110, 113, 104, 78, 48, 25, 8, 1)

totalPopulationChange.lowMigration <- ((sum(persons2041.lowMigration) / sum(persons2016.lowMigration)) - 1) * 100
childrenPopulationChange.lowMigration <- ((sum(persons2041.lowMigration[1:4]) / sum(persons2016.lowMigration[1:4])) - 1) * 100
workingAgePopulationChange.lowMigration <- ((sum(persons2041.lowMigration[5:13]) / sum(persons2016.lowMigration[5:13])) - 1) * 100
pensionableAgeChange.lowMigration <- ((sum(persons2041.lowMigration[14:21]) / sum(persons2016.lowMigration[14:21])) - 1) * 100

ageGroupPopProjection <- data.frame(
  projection = factor(c(rep(c("Principal projection", "50% future EU migration variant", "Low migration variant"), 4))),
  ageGroup = factor(c(rep("Total population", 3), rep("Children", 3), rep("Working age", 3), rep("Pensionable age", 3))),
  populationChange = c(totalPopulationChange, totalPopulationChange.variant, totalPopulationChange.lowMigration,
                       childrenPopulationChange, childrenPopulationChange.variant, childrenPopulationChange.lowMigration,
                       workingAgePopulationChange, workingAgePopulationChange.variant, workingAgePopulationChange.lowMigration,
                       pensionableAgeChange, pensionableAgeChange.variant, pensionableAgeChange.lowMigration))

ukGroupPopulationChange <- data.frame(
  projection = factor(c(rep(c("Principal projection", "50% future EU migration variant"), 4))),
  ageGroup = factor(c(rep("Total population", 2), rep("Children", 2), rep("Working age", 2), rep("Pensionable age", 2))),
  populationChange = c(11.1, 8.9, 2.1, -0.6, 7.7, 5.3, 30.9, 30.5))

ggplot(
  data=ageGroupPopProjection, 
  aes(x=ageGroup, y=populationChange, fill=projection)) +
  geom_bar(stat="identity", position=position_dodge())

ggplot(
  data=ukGroupPopulationChange, 
  aes(x=ageGroup, y=populationChange, fill=projection)) +
  geom_bar(stat="identity", position=position_dodge())



# Sub-national projected percentage change in total population

locations <- c("Ards & North Down", "Antrim & Newtownabbey", "Armagh City, Banbridge & Craigavon", "Belfast", "Causeway Coast & Glens", "Derry City & Strabane", "Fermanagh & Omagh", "Lisburn & Castlereagh", "Mid & East Antrim", "Mid Ulster", "Newry, Mourne & Down")
population2016 <- c(159593, 141032, 210260, 339579, 143525, 150142, 115799, 141181, 137821, 145389, 177816)
population2041 <- c(162934, 146865, 251621, 353280, 142211, 145852, 120137, 167891, 142386, 170575, 199645)
populationChange <- (population2041/population2016 - 1) * 100

populationChange.df <- data.frame(
  location = locations,
  change = populationChange)

ggplot(
  data=populationChange.df, 
  aes(x=locations, y=change)) + 
  geom_bar(stat="identity") + 
  coord_flip()

